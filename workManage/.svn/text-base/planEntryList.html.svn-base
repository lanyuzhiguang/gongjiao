<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="../css/planEntryList.css">
    <link rel="stylesheet" type="text/css" href="../css/layui.css">
    <link rel="stylesheet" type="text/css" href="../css/laydate.css">
    <link rel="stylesheet" type="text/css" href="../css/layer.css">
    <link rel="stylesheet" type="text/css" href="../css/zTreeStyle.css">
    <style>
        .hanging {
            color: #da0109;
        }
        .ztree li span.button.chk.checkbox_true_disable {
            background-position: -14px 0px;
        }
        .redX {
            color: #da0109;
        }

        #pageContent {
            margin: auto;
            text-align: center;
            margin-top: 47px;
        }

        .noDate {
            text-align: center;
            font-size: 14px;

        }

        .activeSelcet {
            background: #2198f2;
            color: #ffffff;
        }

        .addS {
            display: inline-block;
            width: 79px;
            border: 1px solid #c4c4c4;
            text-align: center;
            height: 38px;
            line-height: 38px;
            border-radius: 5px;
        }

        .overSelected {
            color: #2196f1 !important;
        }

        .kind {
            position: relative;
        }

        .officeBtn ul li {
            list-style: none;
            text-align: center;
            width: 100%;
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .officeBtn {
            z-index: 100000;
            width: 99%;
            position: absolute;
            top: 24px;
            background: #e0e0e0;
            border: 1px solid #d5d5d5;
            height: 151px;
            overflow: auto;
        }

        .hid {
            display: none;
        }
    </style>
</head>
<body>
<div>
    <div class="talkRecord">
            <span id="backBtn">
                 <img src="../img/back.png"><span class="back">返回</span>
            </span>
        <span id="where">计划录入</span>
    </div>
    <div class="kindList">
        <div class="headProcess">
            <div class="firstImg"><img src="../img/overHand.png"><span>1</span>
                <div class="wordSetting">基本设置</div>
            </div>
            <div class="lineRed"></div>
            <div class="lastImg"><img src="../img/handingB.png"><span>2</span>
                <div class="checkRegular hanging">计划录入</div>
            </div>
        </div>
        <div class="kindListContent">
            <span class="addKind">添加计划</span>

            <div class="checkList">
                <div class="tableList">
                    <table cellpadding="0" cellspacing="0">
                        <thead>
                        <th style="width: 5%">序号</th>
                        <th style="width: 15%">开始时间</th>
                        <th style="width: 15%">截止时间</th>
                        <th style="width: 10%">任务类型</th>
                        <th>任务内容</th>
                        <th style="width: 15%">参与人员</th>
                        <th width="15%">操作</th>
                        </thead>
                        <tbody id="talkR">
                        <!--<tr>-->
                        <!--<td>1</td>-->
                        <!--<td>2018-01-21</td>-->
                        <!--<td>2018-04-21</td>-->
                        <!--<td>学习</td>-->
                        <!--<td>任务内容任务内容任务内容任务内容任务内容任务内容任务内容</td>-->
                        <!--<td>人员信息</td>-->
                        <!--<td><span>编辑</span><span>删除</span></td>-->
                        <!--</tr>-->
                        </tbody>
                    </table>
                    <div class="noDate hid">暂无数据</div>
                </div>
            </div>
        </div>
    </div>
    <div class="btnList1" style="margin-top: 84px"><span  id="allSub" >下发任务</span></div>
</div>

<div class="mask hid" id="mask"></div>
<div class="popBox hid" id="poper1">
    <div class="popB_Top">
        <span class="addW" id="titleC">添加计划</span><span class="close" id="close"><img src="../img/close.png"></span>
    </div>
    <div class="popB_bottom">
        <div>
            <div><span class="redX">*</span>时间</div>
            <div class="beginDate"><input id="dateA" readonly type="text" value=""><img src="../img/date.png"></div>
            至
            <div class="overDate"><input id="dateB" readonly type="text" value=""><img src="../img/date.png"></div>
        </div>
        <div>
            <div><span class="redX">*</span>任务类型</div>
            <div id="kind">
                <input type="hidden" value="" id="publishId">
                <input readonly type="text" value="" id="publichOffice"><img src="../img/select.png">
                <div class="officeBtn" style="display: none">
                    <ul>

                    </ul>
                </div>
            </div>
        </div>
        <div>
            <div><span class="redX">*</span>任务内容</div>
            <div><textarea id="content"></textarea></div>
        </div>
        <!--<div>-->
        <!--<div><span class="redX">*</span>参与人员</div><div><span class="addS">＋</span></div>-->
        <!--</div>-->
        <!--<div>-->
        <!--<div><span class="redX">*</span>参与人员</div>-->
        <!--<div><textarea id="canPeople"></textarea></div>-->
        <!--</div>-->
    </div>
    <div class="btnList" id="addL"><input type="button" class="s" id="sure" value="确定"><input type="button" class="c" id="cancel"
                                                                                    value="取消"></div>
</div>
<!--//树-->
<div class="mask hid" id="mask1" style="z-index:1001;"></div>
<div class="popBox hid" id="poper">
    <div class="popB_Top">
        <span class="addW" id="title">参与人员</span><span class="close" id="close1"><img src="../img/close.png"></span>
    </div>
    <div class="treeList">
        <div id="menuContent" class="menuContent">
            <ul id="treeDemo" class="ztree" style="margin-top:0; width:206px;"></ul>
        </div>
        <div class="noData hid">你所选择得</div>
    </div>
    <div class="btnList" id="treeB"><input type="button" class="s" id="sure1" value="确定"><input type="button" class="c"
                                                                                     id="cancel1" value="取消"></div>
</div>
</body>
<script src="../assets/js/jquery.js"></script>
<script src="../js/layer.js"></script>
<script src="../js/laydate.js"></script>
<script src="../js/layui.js"></script>
<script src="../js/jquery.ztree.core.min.js"></script>
<script src="../js/jquery.ztree.excheck.min.js"></script>
<iframe id="common" name="common" style="display: none;" src=""></iframe>

<script>
	var blen = false,blsub = true;
    $(function () {
        function getQueryString(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
            var r = window.location.search.substr(1).match(reg);
            if (r != null) return decodeURI(r[2]);
            return null;
        }

        var id = getQueryString("id");
        var type = getQueryString("type");
        var path = "";
        var iframe = document.getElementById("common");
        ///公共页面有公共的属性 一般为使用静态页面获取不到的参数存储的页面
        iframe.src = "../common/common.jsp";//common.jsp  也就是公共页面的相对地址
        if (iframe.attachEvent) {//判断iframe是否加载完成
            iframe.attachEvent("onload", function () {
                getCommon();
            });
        } else {
            iframe.onload = function () {
                getCommon();
            };
        }

        //获取公共参数  一般为存储在session里面的数据
        function getCommon() {//如果有需要在session 里面的参数可以在common.jsp页面里面获取
            var frames = window.frames["common"];
            path = frames._ctxPath;//获取项目名称  即如 /dangjian    /项目名  ---》 这个跟在服务器里面配置的有关
            var _qiniuImageHost = frames._qiniuImageHost;//七牛云公共地址头

            $("#backBtn").click(function () {
                window.history.back(-1);
            });
            //时间插件方法
            laydate.render({
                elem: "#dateA",
                type: "date"
            });
            //时间插件方法
            laydate.render({
                elem: "#dateB",
                type: "date"
            });
            var bianId="";
            var selectednodeName="";
            var selectednodeId="";
            $("#backList").click(function () {
                window.location.href="EntryPlan.html";
            });
            $("#allSub").click(function () {
                $.ajax({
                    type: "POST",
                    url: path + "/planBasic/subBasic.action",
                    data: {"palnBasicId":id},
                    dataType: "json",
                    contentType: "application/x-www-form-urlencoded; charset=utf-8",
                    success: function (data) {
                        if(data.success){
                            window.location.href="EntryPlan.html";
                        }else{
                            parent.layer.alert(data.message);
                        }

                    }

                })
            });
            $(".addKind").click(function () {
            	blen=true;
                $("#dateA").val("");
                $("#dateB").val("");
                $("#publichOffice").val("");
                $("#publishId").val("");
                $("#content").val("");

                $("#poper1").removeClass("hid");
                $("#mask").removeClass("hid");

                $("div").remove(".cS");
                $.ajax({
                    type: "POST",
                    url: path + "/taskType/findByUser.action",
                    data: {},
                    dataType: "json",
                    contentType: "application/x-www-form-urlencoded; charset=utf-8",
                    success: function (data) {
                        var data = data;
                        for (var i = 0; i < data.length; i++) {
                            var oLi = "<li data-id=" + data[i]._id + ">" + data[i].name + "</li>";
                            $(".officeBtn ul").append(oLi);
                        }
                        //考核发布单位
                        $("#publichOffice").click(function (e) {
                            $(this).next().next().slideDown();
                            e.stopPropagation();
                        });
                        $(".officeBtn ul li").mouseover(function () {
                            $(".officeBtn ul li").removeClass("activeSelcet");
                            $(this).addClass("activeSelcet");
                        });
                        $("body").click(function () {
                            $(".officeBtn").slideUp();
                        });
                        $(".officeBtn ul li").click(function () {
                            $(this).parents(".officeBtn").prevAll("#publichOffice").val($(this).text());
                            $(this).parents(".officeBtn").prevAll("#publichOffice").prev().val($(this).attr("data-id"));
                        });
                    }
                });

                $("#cancel").click(function () {
                    $("#poper1").addClass("hid");
                    $("#mask").addClass("hid");
                });
                $("#close").click(function () {
                    $("#poper1").addClass("hid");
                    $("#mask").addClass("hid");
                });
                $("#mask").click(function () {
                    $("#poper1").addClass("hid");
                    $("#mask").addClass("hid");
                });

                if (type == 1 || type == 5) {
                    $(".popB_bottom").append('   <div  class="cS">\n' +
                        '            <div><span class="redX">*</span>参与人员</div><div style="height:38px;margin-left:4px;cursor:pointer;"><span class="addS">＋</span></div>\n' +
                        '        </div>');
                } else {
                    $(".popB_bottom").append('<div class="cS">\n' +
                        '            <div ><span class="redX">*</span>参与人员</div>\n' +
                        '            <div><textarea id="canPeople"></textarea></div>\n' +
                        '        </div>');
                }
                $("#sure").click(function () {
                    if ($("#dateA").val() == "") {
                        parent.layer.alert('请选择开始时间！');
                        return;
                    }
                    if ($("#dateB").val() == "") {
                        parent.layer.alert('请选择结束时间！');
                        return;
                    }
                    if ($("#publichOffice").val() == "") {
                        parent.layer.alert('请选择任务类型！');
                        return;
                    }
                    if ($("#content").val().trim() == "") {
                        parent.layer.alert('请填写任务内容！');
                        return;
                    }
                    if (type == 1 || type == 5) {
                        if ($(".addS").text() != "已选择") {
                            parent.layer.alert('请选择参与人员！');
                            return;
                        }
                    } else {
                        if ($("#canPeople").val().trim() == "") {
                            parent.layer.alert('请填写参与人员！');
                            return;
                        }
                    }
                    if (type == 1 || type == 5) {
                        $.ajax({
                            type: "POST",
                            url: path + "/planReule/upsert.action",
                            data: {
                                "taskId": $("#publishId").val(),
                                "taskName": $("#publichOffice").val(),
                                "content": $("#content").val(),
                                "starPlanDate": $("#dateA").val(),
                                "endPlanDate": $("#dateB").val(),
                                "userNames":selectednodeName,
                                "userIds":selectednodeId,
                                "planBasicId":id
                            },
                            dataType: "json",
                            contentType: "application/x-www-form-urlencoded; charset=utf-8",
                            success: function (data) {
                                if(data.success){
                                    window.location.reload();
                                }else{
                                    parent.layer.alert(data.message);
                                }

                            }
                        })
                    } else {
                        $.ajax({
                            type: "POST",
                            url: path + "/planReule/upsert.action",
                            data: {
                                "taskId": $("#publishId").val(),
                                "taskName": $("#publichOffice").val(),
                                "content": $("#content").val(),
                                "starPlanDate": $("#dateA").val(),
                                "endPlanDate": $("#dateB").val(),
                                "userNames": $("#canPeople").val(),
                                "planBasicId":id
                            },
                            dataType: "json",
                            contentType: "application/x-www-form-urlencoded; charset=utf-8",
                            success: function (data) {
                                if(data.success){
                                    window.location.reload();
                                }else{
                                    parent.layer.alert(data.message);
                                }
                            }
                        })
                    }

                });
            });

            $(document).on("click", ".addS", function () {
                if(blen){//添加人员
                    $("#poper").removeClass("hid");
                    $("#mask1").removeClass("hid");
                    $("#treeB").removeClass("hid");
                    var zNodes = [];
                  	//tree
                    var setting = {
						check: {
							enable: true,
							chkboxType: { "Y" : "", "N" : "" }
						},
						data: {
							simpleData: {
								enable: true
							}
						}
					};

					if(blsub){
                    	buildTree();
                    	blsub=false;
					}

                    //生成树
                    function buildTree() {
                        $.ajax({
                            type: "POST",
                            url: path + "/zTreeData/findBUType.action",
                            data: {
                                "planId":id,
                                "type":type
                            },
                            dataType: "json",
                            contentType: "application/x-www-form-urlencoded; charset=utf-8",
                            success: function (data) {
                                var data = data.data;
                                if (data) {
                                    zNodes = data;
                                    var zTree = $.fn.zTree.init($("#treeDemo"), setting, zNodes);
                                    var treeObj = $.fn.zTree.getZTreeObj("treeDemo");
                                    treeObj.expandAll(true);
                                }
                            }
                        });
                    }

                    $("#cancel1").click(function () {
                        $("#poper").addClass("hid");
                        $("#mask1").addClass("hid");
                    });
                    $("#close1").click(function () {
                        $("#poper").addClass("hid");
                        $("#mask1").addClass("hid");
                    });
                    $("#mask1").click(function () {
                        $("#poper").addClass("hid");
                        $("#mask1").addClass("hid");
                    });
                    $("#sure1").click(function () {
                        allSelectedNode();
                        $("#poper").addClass("hid");
                        $("#mask1").addClass("hid");
                        $(".addS").text("已选择").addClass("overSelected");
                    });
                    //所有选中的节点
                    function allSelectedNode() {
                        var treeObj = $.fn.zTree.getZTreeObj("treeDemo");
                        var nodes = treeObj.transformToArray(treeObj.getNodes());
                        for(var node in nodes){
                            if(nodes[node].chkDisabled==true){
                                continue;
                            }else {
                                //判断节点是否选中
                                var checked = nodes[node].checked;
                                if(checked==true){
                                    selectednodeName+= nodes[node].name+",";
                                    selectednodeId+=nodes[node].id+",";
                                }
                            }
                        }
                    }
                }else{//查看
                    parent.layer.alert(' 只能查看,不能修改,如果要修改可以删除当前条计划然后重新创建！');
                    $("#poper").removeClass("hid");
                    $("#mask1").removeClass("hid");
                    $("#treeB").addClass("hid");
                    var zNodes = [];
                    //tree
                    var setting = {
                        view: {
                            dblClickExpand: false
                        },
                        data: {
                            simpleData: {
                                enable: true,
                                idKey: "id",
                                pIdKey: "pId"
                            },
                            key: {
                                name: "name"
                            }
                        },
                        check: {
                            enable: true,
                            chkDisabledInherit: true,
                            chkStyle: "checkbox",
                            chkboxType: {"Y": "", "N": ""}
                        },
                        callback: {

                        }
                    };
                    buildTree();

                    function buildTree() {
                        $.ajax({
                            type: "POST",
                            url: path + "/zTreeData/findBULook.action",
                            data: {
                                "ruleId":bianId
                            },
                            dataType: "json",
                            contentType: "application/x-www-form-urlencoded; charset=utf-8",
                            success: function (data) {
                                var data = data.data;
                                if (data) {
                                    zNodes = data;
                                    var zTree = $.fn.zTree.init($("#treeDemo"), setting, zNodes);
                                    var node = zTree.getNodeByParam("id", 0);
                                    //alert(JSON.stringify(node));
                                    zTree.selectNode(node);
                                    zTree.expandNode(node, true, false, false);
                                    var treeObj = $.fn.zTree.getZTreeObj("treeDemo");
                                    treeObj.expandAll(true);
                                }
                                hibb_Nodes();

                            }
                        });
                    }

                    $("#close1").click(function () {
                        $("#poper").addClass("hid");
                        $("#mask1").addClass("hid");
                    });
                    $("#mask1").click(function () {
                        $("#poper").addClass("hid");
                        $("#mask1").addClass("hid");
                    });

                    function hibb_Nodes() {
                        var treeObj = $.fn.zTree.getZTreeObj("treeDemo");
                        var nodes = treeObj.transformToArray(treeObj.getNodes());
                        for(var node in nodes){
                            treeObj.setChkDisabled(nodes[node],true);
                        }
                    }

                }

            });
            $.ajax({
                type: "POST",
                url: path + "/planReule/findPlanById.action",
                data: {"basicId": id},
                dataType: "json",
                contentType: "application/x-www-form-urlencoded; charset=utf-8",
                success: function (data) {
                    if (data.length == 0) {
                        $(".noDate").removeClass("hid");
                        $(".btnList1").addClass("hid");
                    }else{
                        $(".noDate").addClass("hid");
                        $(".btnList1").removeClass("hid");
                    }
                    for (var i = 0; i < data.length; i++) {
                        if(type==1||type==5){
                            var oTr = '<tr>\n' +
                                '                            <td>' + (i + 1) + '</td>\n' +
                                '                            <td>' + data[i].formStarPlanDate + '</td>\n' +
                                '                            <td>' + data[i].formEndPlanDate + '</td>\n' +
                                '                            <td>' + data[i].taskName + '</td>\n' +
                                '                            <td>' + data[i].content + '</td>\n' +
                                '                            <td><input type="hidden" value=' + data[i]._id + '><span class="renLook">查看</span></td>\n' +
                                '                            <td><input type="hidden" value=' + data[i]._id + '><span>编辑</span><span>删除</span></td>\n' +
                                '                        </tr>';
                        }else{
                            var oTr = '<tr>\n' +
                                '                            <td>' + (i + 1) + '</td>\n' +
                                '                            <td>' + data[i].formStarPlanDate + '</td>\n' +
                                '                            <td>' + data[i].formEndPlanDate + '</td>\n' +
                                '                            <td>' + data[i].taskName + '</td>\n' +
                                '                            <td>' + data[i].content + '</td>\n' +
                                '                            <td>' + data[i].userNames + '</td>\n' +
                                '                            <td><input type="hidden" value=' + data[i]._id + '><span>编辑</span><span>删除</span></td>\n' +
                                '                        </tr>';
                        }

                        $("#talkR").append(oTr);
                    }


                    $('#talkR').on("click", function (e) {
                        var target = e.target;
                        if($(target).text() == "查看"){
                            var currId = $(target).parent().find("input").val();
                            $("#poper").removeClass("hid");
                            $("#mask1").removeClass("hid");
                            $("#treeB").addClass("hid");
                            var zNodes = [];
                            //tree
                            var setting = {
                                view: {
                                    dblClickExpand: false
                                },
                                data: {
                                    simpleData: {
                                        enable: true,
                                        idKey: "id",
                                        pIdKey: "pId"
                                    },
                                    key: {
                                        name: "name"
                                    }
                                },
                                check: {
                                    enable: true,
                                    chkDisabledInherit: true,
                                    chkStyle: "checkbox",
                                    chkboxType: {"Y": "", "N": ""}
                                },
                                callback: {

                                }
                            };
                            buildTree();

                            function buildTree() {
                                $.ajax({
                                    type: "POST",
                                    url: path + "/zTreeData/findBULook.action",
                                    data: {
                                        "ruleId":currId
                                    },
                                    dataType: "json",
                                    contentType: "application/x-www-form-urlencoded; charset=utf-8",
                                    success: function (data) {
                                        var data = data.data;
                                        if (data) {
                                            zNodes = data;
                                            var zTree = $.fn.zTree.init($("#treeDemo"), setting, zNodes);
                                            var node = zTree.getNodeByParam("id", 0);
                                            //alert(JSON.stringify(node));
                                            zTree.selectNode(node);
                                            zTree.expandNode(node, true, false, false);
                                            var treeObj = $.fn.zTree.getZTreeObj("treeDemo");
                                            treeObj.expandAll(true);
                                        }
                                        hibb_Nodes();

                                    }
                                });
                            }

                            $("#close1").click(function () {
                                $("#poper").addClass("hid");
                                $("#mask1").addClass("hid");
                            });
                            $("#mask1").click(function () {
                                $("#poper").addClass("hid");
                                $("#mask1").addClass("hid");
                            });


                            function hibb_Nodes() {
                                var treeObj = $.fn.zTree.getZTreeObj("treeDemo");
                                var nodes = treeObj.transformToArray(treeObj.getNodes());
                                for(var node in nodes){
                                    treeObj.setChkDisabled(nodes[node],true);
                                }
                            }
                        }
                        if ($(target).text() == "删除") {
                            parent.layer.confirm('删除该计划任务相关人员的填报信息均会被删除,是否确认删除？', {
                                icon: 3,
                                title: '\n' + '提示'
                            }, function (index) {
                                var currId = $(target).parent().find("input").val();
                                $.ajax({
                                    type: "POST",
                                    url: path + "/planReule/remove.action",
                                    data: {
                                        "palnRuleId": currId
                                    },
                                    dataType: "json",
                                    contentType: "application/x-www-form-urlencoded; charset=utf-8",
                                    success: function (data) {
                                        if(data.success){
                                            parent.layer.alert('删除成功！');
                                            window.location.reload();
                                        }

                                    }
                                });
                                parent.layer.close(index);
                            })
                        }
                        if ($(target).text() == "编辑") {
                            blen=false;
                            var currId = $(target).parent().find("input").val();
                            bianId=currId;
                            $("#poper1").removeClass("hid");
                            $("#mask").removeClass("hid");
                            $("#titleC").text("编辑计划");
                            $("div").remove(".cS");
                            $.ajax({
                                type: "POST",
                                url: path + "/taskType/findByUser.action",
                                data: {},
                                dataType: "json",
                                contentType: "application/x-www-form-urlencoded; charset=utf-8",
                                success: function (data) {
                                    var data = data;
                                    for (var i = 0; i < data.length; i++) {
                                        var oLi = "<li data-id=" + data[i]._id + ">" + data[i].name + "</li>";
                                        $(".officeBtn ul").append(oLi);
                                    }
                                    //考核发布单位
                                    $("#publichOffice").click(function (e) {
                                        $(this).next().next().slideDown();
                                        e.stopPropagation();
                                    });
                                    $(".officeBtn ul li").mouseover(function () {
                                        $(".officeBtn ul li").removeClass("activeSelcet");
                                        $(this).addClass("activeSelcet");
                                    });
                                    $("body").click(function () {
                                        $(".officeBtn").slideUp();
                                    });
                                    $(".officeBtn ul li").click(function () {
                                        $(this).parents(".officeBtn").prevAll("#publichOffice").val($(this).text());
                                        $(this).parents(".officeBtn").prevAll("#publichOffice").prev().val($(this).attr("data-id"));
                                    });
                                }
                            });
                            $.ajax({
                                type: "POST",
                                url: path + "/planReule/findRuleById.action",
                                data: {"planRuleId":currId},
                                dataType: "json",
                                contentType: "application/x-www-form-urlencoded; charset=utf-8",
                                success: function (data) {
                                    var data = data.data;
                                    $("#dateA").val(data.formStarPlanDate);
                                    $("#dateB").val(data.formEndPlanDate);
                                    $("#publichOffice").val(data.taskName);
                                    $("#publishId").val(data.taskId);
                                    $("#content").val(data.content);
                                    if (type == 1 || type == 5) {
                                        $(".popB_bottom").append('   <div  class="cS">\n' +
                                            '            <div><span class="redX">*</span>参与人员</div><div style="height:38px;margin-left:4px;cursor:pointer;"><span class="addS overSelected">已选择</span></div>\n' +
                                            '        </div>');
                                    } else {
                                        var temp='<div class="cS">\n '+
                                            '<div ><span class="redX">*</span>参与人员</div>\n' +
                                            '<div><textarea id="canPeople" value=""></textarea></div>\n' +
                                            '</div>';
                                        $(".popB_bottom").append(temp);
                                        $("#canPeople").val(data.userNames);
                                    }
                                }
                            });

                            $("#cancel").click(function () {
                                $("#poper1").addClass("hid");
                                $("#mask").addClass("hid");
                            });
                            $("#close").click(function () {
                                $("#poper1").addClass("hid");
                                $("#mask").addClass("hid");
                            });
                            $("#mask").click(function () {
                                $("#poper1").addClass("hid");
                                $("#mask").addClass("hid");
                            });


                            $("#sure").click(function () {
                                if ($("#dateA").val() == "") {
                                    parent.layer.alert('请选择开始时间！');
                                    return;
                                }
                                if ($("#dateB").val() == "") {
                                    parent.layer.alert('请选择结束时间！');
                                    return;
                                }
                                if ($("#publichOffice").val() == "") {
                                    parent.layer.alert('请选择任务类型！');
                                    return;
                                }
                                if ($("#content").val().trim() == "") {
                                    parent.layer.alert('请填写任务内容！');
                                    return;
                                }
                                if (type == 1 || type == 5) {
                                    if ($(".addS").text() != "已选择") {
                                        parent.layer.alert('请选择参与人员！');
                                        return;
                                    }
                                } else {
                                    if ($("#canPeople").val().trim() == "") {
                                        parent.layer.alert('请填写参与人员！');
                                        return;
                                    }
                                }
                                if (type == 1 || type == 5) {
                                    $.ajax({
                                        type: "POST",
                                        url: path + "/planReule/upsert.action",
                                        data: {
                                            "taskId": $("#publishId").val(),
                                            "taskName": $("#publichOffice").val(),
                                            "content": $("#content").val(),
                                            "starPlanDate": $("#dateA").val(),
                                            "endPlanDate": $("#dateB").val(),
                                            "userNames":selectednodeName,
                                            "userIds":selectednodeId,
                                            "planBasicId":id,
                                            "_id":currId
                                        },
                                        dataType: "json",
                                        contentType: "application/x-www-form-urlencoded; charset=utf-8",
                                        success: function (data) {
                                            if(data.success){
                                                window.location.reload();
                                                blsub=true;
                                            }else{
                                                parent.layer.alert(data.message);
                                            }

                                        }
                                    })
                                } else {
                                    $.ajax({
                                        type: "POST",
                                        url: path + "/planReule/upsert.action",
                                        data: {
                                            "_id":currId,
                                            "taskId": $("#publishId").val(),
                                            "taskName": $("#publichOffice").val(),
                                            "content": $("#content").val(),
                                            "starPlanDate": $("#dateA").val(),
                                            "endPlanDate": $("#dateB").val(),
                                            "userNames": $("#canPeople").val(),
                                            "planBasicId":id
                                        },
                                        dataType: "json",
                                        contentType: "application/x-www-form-urlencoded; charset=utf-8",
                                        success: function (data) {
                                            if(data.success){
                                            	blsub=true;
                                                window.location.reload();
                                            }else{
                                                parent.layer.alert(data.message);
                                            }
                                        }
                                    })
                                }

                            });
                        }
                    })
                }
            })
        }
    })
</script>
</html>